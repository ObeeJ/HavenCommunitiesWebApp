<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Supabase Connection</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .test {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00aa00;
        }
    </style>
</head>
<body>
    <h1>üîç Supabase Connection Verification</h1>
    <p class="info">Let me check if everything is actually connected...</p>
    
    <div class="test">
        <h2>1Ô∏è‚É£ Checking Credentials</h2>
        <div id="credentials-check">Running...</div>
    </div>
    
    <div class="test">
        <h2>2Ô∏è‚É£ Testing Server Health</h2>
        <div id="health-check">Running...</div>
    </div>
    
    <div class="test">
        <h2>3Ô∏è‚É£ Testing Newsletter Subscription</h2>
        <button onclick="testNewsletter()">Test Newsletter API</button>
        <div id="newsletter-check"></div>
    </div>
    
    <div class="test">
        <h2>4Ô∏è‚É£ Testing Contact Form</h2>
        <button onclick="testContact()">Test Contact API</button>
        <div id="contact-check"></div>
    </div>
    
    <div class="test">
        <h2>5Ô∏è‚É£ Testing Authentication</h2>
        <button onclick="testAuth()">Test Auth API</button>
        <div id="auth-check"></div>
    </div>
    
    <div class="test">
        <h2>üìä Final Verdict</h2>
        <div id="verdict">Waiting for tests to complete...</div>
    </div>

    <script>
        // Get credentials from environment or prompt user
        const SUPABASE_URL = prompt('Enter your VITE_SUPABASE_URL:') || 'https://your-project.supabase.co';
        const ANON_KEY = prompt('Enter your VITE_SUPABASE_ANON_KEY:') || 'your-anon-key';
        const API_URL = `${SUPABASE_URL}/functions/v1/make-server-59b4d089`;
        
        // Extract project ID from URL for display
        const PROJECT_ID = SUPABASE_URL.split('//')[1]?.split('.')[0] || 'unknown';
        
        let testResults = {
            credentials: false,
            health: false,
            newsletter: false,
            contact: false,
            auth: false
        };

        // Check 1: Credentials
        function checkCredentials() {
            const div = document.getElementById('credentials-check');
            
            if (PROJECT_ID && ANON_KEY && PROJECT_ID.length > 10 && ANON_KEY.length > 50) {
                div.innerHTML = `
                    <span class="success">‚úÖ PASS</span><br>
                    Project ID: <span class="info">${PROJECT_ID}</span><br>
                    Anon Key: <span class="info">${ANON_KEY.substring(0, 20)}...</span>
                `;
                testResults.credentials = true;
            } else {
                div.innerHTML = `<span class="error">‚ùå FAIL - Credentials missing or invalid</span>`;
            }
        }

        // Check 2: Health
        async function checkHealth() {
            const div = document.getElementById('health-check');
            
            try {
                console.log('Testing health endpoint:', `${API_URL}/health`);
                
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Health response:', data);
                
                if (response.ok && data.status === 'ok') {
                    div.innerHTML = `
                        <span class="success">‚úÖ PASS</span><br>
                        Server is responding!<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    testResults.health = true;
                } else {
                    div.innerHTML = `
                        <span class="warning">‚ö†Ô∏è PARTIAL</span><br>
                        Server responded but status unclear<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('Health check error:', error);
                div.innerHTML = `
                    <span class="error">‚ùå FAIL</span><br>
                    Error: ${error.message}<br>
                    <span class="info">This usually means the server endpoint doesn't exist or CORS is blocking.</span>
                `;
            }
        }

        // Check 3: Newsletter
        async function testNewsletter() {
            const div = document.getElementById('newsletter-check');
            div.innerHTML = '<span class="info">Testing...</span>';
            
            try {
                const testEmail = `test-${Date.now()}@example.com`;
                console.log('Testing newsletter with:', testEmail);
                
                const response = await fetch(`${API_URL}/newsletter/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: testEmail })
                });
                
                const data = await response.json();
                console.log('Newsletter response:', data);
                
                if (data.success) {
                    div.innerHTML = `
                        <span class="success">‚úÖ PASS</span><br>
                        Successfully subscribed: ${testEmail}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    testResults.newsletter = true;
                } else {
                    div.innerHTML = `
                        <span class="warning">‚ö†Ô∏è FAIL</span><br>
                        Response: ${data.message}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('Newsletter test error:', error);
                div.innerHTML = `
                    <span class="error">‚ùå FAIL</span><br>
                    Error: ${error.message}
                `;
            }
            
            updateVerdict();
        }

        // Check 4: Contact
        async function testContact() {
            const div = document.getElementById('contact-check');
            div.innerHTML = '<span class="info">Testing...</span>';
            
            try {
                const testData = {
                    name: 'Test User',
                    email: `test-${Date.now()}@example.com`,
                    message: 'This is a test message from verification script'
                };
                console.log('Testing contact with:', testData);
                
                const response = await fetch(`${API_URL}/contact`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                console.log('Contact response:', data);
                
                if (data.success) {
                    div.innerHTML = `
                        <span class="success">‚úÖ PASS</span><br>
                        Successfully submitted contact form<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    testResults.contact = true;
                } else {
                    div.innerHTML = `
                        <span class="warning">‚ö†Ô∏è FAIL</span><br>
                        Response: ${data.message}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('Contact test error:', error);
                div.innerHTML = `
                    <span class="error">‚ùå FAIL</span><br>
                    Error: ${error.message}
                `;
            }
            
            updateVerdict();
        }

        // Check 5: Auth
        async function testAuth() {
            const div = document.getElementById('auth-check');
            div.innerHTML = '<span class="info">Testing signup...</span>';
            
            try {
                const testEmail = `admin-test-${Date.now()}@example.com`;
                const testData = {
                    email: testEmail,
                    password: 'TestPassword123!',
                    name: 'Test Admin'
                };
                console.log('Testing signup with:', testEmail);
                
                const response = await fetch(`${API_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                console.log('Auth response:', data);
                
                if (data.success) {
                    div.innerHTML = `
                        <span class="success">‚úÖ PASS</span><br>
                        Successfully created test admin account<br>
                        Email: ${testEmail}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    testResults.auth = true;
                } else {
                    div.innerHTML = `
                        <span class="warning">‚ö†Ô∏è FAIL</span><br>
                        Response: ${data.message}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('Auth test error:', error);
                div.innerHTML = `
                    <span class="error">‚ùå FAIL</span><br>
                    Error: ${error.message}
                `;
            }
            
            updateVerdict();
        }

        function updateVerdict() {
            const div = document.getElementById('verdict');
            const passed = Object.values(testResults).filter(v => v === true).length;
            const total = Object.keys(testResults).length;
            
            let verdict = '';
            if (passed === total) {
                verdict = `<span class="success">üéâ ALL TESTS PASSED (${passed}/${total})</span><br>Supabase is FULLY CONNECTED and working!`;
            } else if (passed >= 3) {
                verdict = `<span class="warning">‚ö†Ô∏è MOSTLY WORKING (${passed}/${total})</span><br>Some features may not work properly.`;
            } else if (passed >= 1) {
                verdict = `<span class="warning">‚ö†Ô∏è PARTIALLY WORKING (${passed}/${total})</span><br>Supabase is connected but some endpoints are failing.`;
            } else {
                verdict = `<span class="error">‚ùå NOT WORKING (${passed}/${total})</span><br>Supabase connection failed. Check your setup.`;
            }
            
            div.innerHTML = verdict + '<br><br>Results:<br><pre>' + JSON.stringify(testResults, null, 2) + '</pre>';
        }

        // Run initial checks
        checkCredentials();
        checkHealth();
        
        console.log('=== SUPABASE VERIFICATION ===');
        console.log('Project ID:', PROJECT_ID);
        console.log('API URL:', API_URL);
        console.log('Open the browser console (F12) to see detailed logs');
    </script>
</body>
</html>
